name: Update README with Hackatime Stats

on:
  push:
    branches: [main]
  schedule:
    # Daily at midnight UTC - change this line to modify schedule:
    - cron: "0 0 * * *" # Daily at midnight UTC (ACTIVE)
    # - cron: "0 */6 * * *"   # Every 6 hours
    # - cron: "0 0,12 * * *"  # Twice daily (midnight & noon UTC)
    # - cron: "0 0 * * 1"     # Weekly on Mondays
    # - cron: "0 */3 * * *"   # Every 3 hours
    # - cron: "0 9 * * *"     # Daily at 9 AM UTC
  workflow_dispatch: # Manual trigger - go to Actions tab and click "Run workflow"

jobs:
  update-hackatime-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install Python dependencies
        run: |
          pip install requests

      - name: Generate README with Hackatime data
        env:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
        run: |
          echo "ğŸš€ Starting Hackatime stats update..."
          echo "â° Current time: $(date)"
          echo "ğŸ”‘ API Key present: $([ -n "$WAKATIME_API_KEY" ] && echo "âœ… Yes" || echo "âŒ No")"
          python3 update_readme.py
          echo "âœ… README generation completed!"

      - name: Verify and commit changes
        run: |
          echo "ğŸ” Checking for README changes..."
          git config --local user.email "actions@github.com"
          git config --local user.name "hackatime-bot ğŸ¤–"
          git remote set-url origin https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git

          # Check if README was actually updated
          if [ -f README.md ]; then
            echo "âœ… README.md exists"
            if grep -q "Last updated:" README.md; then
              echo "âœ… README contains timestamp - update successful!"
            else
              echo "âš ï¸ README might not have been updated properly"
            fi
          else
            echo "âŒ README.md not found!"
            exit 1
          fi

          git add README.md
          if git diff --staged --quiet; then
            echo "ğŸ“ No changes to commit - stats are up to date"
          else
            echo "ğŸ“Š Changes detected - committing update..."
            git commit -m "ğŸ“Š Update README with latest Hackatime stats [$(date +'%Y-%m-%d %H:%M UTC')]"
            git push origin main
            echo "âœ… Successfully pushed updated README!"
          fi

      - name: Workflow completion summary
        if: always()
        run: |
          echo "ğŸ¯ Workflow Summary:"
          echo "â° Completed at: $(date)"
          echo "ğŸ”„ Next scheduled run: Tomorrow at midnight UTC"
          echo "ğŸ‘€ Check your README at: https://github.com/${{ github.repository }}"
          echo "ğŸ“Š Manual trigger: Go to Actions tab â†’ 'Update README with Hackatime Stats' â†’ 'Run workflow'"
